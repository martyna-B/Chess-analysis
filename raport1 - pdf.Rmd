---
title: "Raport 1"
author: "Martyna Bielec, Maciej Karczewski"
date: '2022-11-23'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
df <- read.csv(file = "C:/Users/Martyna/Studia/Pakiety statystyczne/raport1/chess_games.csv")

library("stringr")
library("ggplot2")
library(tidyr)
library(reshape2)
library(dplyr)

df <- na.omit(df)
df <- distinct(df)

#Dodawanie nowych kolumn ------------------------------
df <-  df %>% mutate(
    white_win = ifelse(winner =='white',1,0),
    black_win = ifelse(winner =='black',1,0),
    draw = ifelse(winner =='draw',1,0)
)
df <- cbind(df,white_ranking_cat=(df$white_rating %/% 100 + 1) * 100)
df <- cbind(df,ranting_difrents=df$white_rating-df$black_rating)
df <- cbind(df,rating_diffrents_cat=(df$ranting_difrents %/% 100 + 1)* 100)
df <- cbind(df,turns_cat=(df$turns %/% 10 + 1)* 10)


#openingi
openings <- vector()

for(i in 1:nrow(df)){
  
  opening_name <- df[i, c("opening_name")]
  
  if(str_detect(opening_name, ":") == TRUE){
    
    location <- str_locate(opening_name, ":")
    openings[i] <- str_sub(opening_name, 1, location[1,1] - 1)
  }
  
  else if(str_detect(opening_name, "#") == TRUE){
    
    location <- str_locate(opening_name, "#")
    openings[i] <- str_sub(opening_name, 1, location[1,1] - 2)
  }
  
  else if(str_detect(opening_name, "\\|") == TRUE){
    
    
    location <- str_locate(opening_name, "\\|")
    openings[i] <- str_sub(opening_name, 1, location[1,1] - 1)
  }
  
  else{
    
    openings[i] <- df[i, c("opening_name")]
    
  }
  
  
}

df["openings_general"] <- openings

#Inne data framy do generowania wykresďż˝w

#wygrana_czas <- aggregate(df$wygrana_bialego,list(df$turns_cat),mean)
#wygrana_rating<- aggregate(df$wygrana_bialego,list(df$white_ranking_cat),mean)
#wygrana_roznica<- aggregate(df$wygrana_bialego,list(df$rating_diffrents_cat),mean)

openings_sicilian <- vector()

for(i in 1:nrow(df)){
  
  opening_name <- df[i, c("opening_name")]
  
  if(str_detect(opening_name, "Sicilian Defense: ") == TRUE){
    
    openings_sicilian[i] <- opening_name
  }
  
  else{
    
    openings_sicilian[i] <- 0
    
  }
}
```

## Wprowadzenie

Strona internetowa Lichess jest drugą co do wielkości platformą na świecie, która umożliwia grę w szachy online. Użytkownicy mogą grać z$~$komputerem lub między sobą. Każdy gracz ma przypisany ranking, który jest ustalany na podstawie jego umiejętności. Jeśli użytkownik rozgrywa partię "rankingową", w jej wyniku jego ranking rośnie lub maleje.

Dane, które zostaną poddane analizie, zawierają informacje o$~$ponad 20 000$~$rozgrywkach szachowych ze strony Lichess Games. Dostępne są na witrynie kaggle. Składają się z następujących kolumn:



- id (zawiera elementy typu "character") - numer ID rozgrywki
- rated ("character") - wartość "True" lub "False" w$~$zależności od tego, czy partia jest "rankingowa"
- created_at ("numeric") - czas rozpoczęcia gry
- last_move_at ("numeric") - czas zakończenia gry
- turns ("numeric") - liczba rozegranych tur
- victory_status ("character") - status zakończenia gry: "mate" dla zakończenia matem, "resign" dla zakończenia przez poddanie się jednej ze stron, "draw" dla remisu lub "outoftime" dla rozgrywki zakończonej z powodu upływu czasu
- winner ("character") - zwycięzca gry: "white", jeśli wygrał gracz biały, "black", jeśli czarny lub "draw" w$~$przypadku remisu
- increment_code ("character") - składa się z dwóch liczb rozdzielonych znakiem "+"; pierwsza oznacza liczbę minut przypadających na gracza na wszystkie jego ruchy, druga liczbę sekund, o którą zwiększa się czas gracza po wykonaniu ruchu
- white_id ("character") - ID gracza białego
- white_rating ("numeric") - ranking gracza białego
- black_id ("character") - ID gracza czarnego
- black_rating ("numeric") - ranking gracza czarnego
- moves ("character") - wszystkie ruchy zapisane w$~$standardowej notacji szachowej
- opening_eco ("character") - standaryzowany kod dla rozgranego otwarcia
- opening_name ("character") - nazwa rozgranego otwarcia
- opening_ply ("character") - liczba ruchów w$~$fazie otwarcia
 
Celem analizy będzie odpowiedzenie na pytanie - jakie jest prawdopodobieństwo różnych zakończeń gry: wygranej białego gracza, czarnego lub remisu? Będziemy rozważać ten problem pod kątem rozegranego otwarcia, rankingu graczy, różnicy w$~$rankingu między graczem białym i$~$czarnym oraz liczby tur w$~$partii.


## Obróbka danych

### Otwarcia (?)

W raporcie przeanalizujemy prawdopodobieńtwo różnych zakończeń rozgrywki także ze względu na wybrane otwarcie. Aby uzyskać rzetelne wyniki, nie możemy uwzględnić otwarć, które rozegrała zbyt mała liczba graczy. Okazuje się jednak, że kolumna opening_name zawiera 1477 unikalnych wartości. Dzieje się tak, ponieważ dane rozróżniają wiele wariantów poszczególnych otwarć. Przykładowo "obrona sycylijska" została rozegrana w 181 różnych wariantach, takich jak:

```{r, echo=FALSE}
print(unique(openings_sicilian)[2:6])
```

W celu umożliwienia analizy otwarć stworzyliśmy nową kolumnę, zawierającą jedynie nazwę otwarcia (bez uwzględnienia wariantu). Nazwaliśmy ją "openings_general". Zawiera ona 149 wartości unikalnych. Przeanalizujemy sześć najczęściej rozgrywanych otwarć, czyli:

```{r, echo=FALSE}
agg_tbl <- df %>% group_by(openings_general) %>% 
  summarise(total_count=n(),
            .groups = 'drop')

agg_tbl_ordered <-agg_tbl[order(agg_tbl$total_count, decreasing=TRUE),]
head(agg_tbl_ordered)
```
gdzie kolumna "total_count" oznacza liczbę rozegranych gier z wykorzystaniem danego otwarcia.

## Analiza danych


### Prawdopodobieństwo różnych zakończeń rozgrywki bez warunkowania.

W celu rozważenia od czego zależy prawdopodobieństwo różnych zakończeń rozgrywki, najpierw oszacowaliśmy to prawdobieństwo w ogólności. Liczba rozegranych partii wynosi:

```{r}
games_count = sum(df$winner != "a")
print(games_count)
```

Z czego gracz biały wygrał następującą liczbę razy:

```{r}
white_winner_count = sum(df$winner == "white")
print(white_winner_count)
```

Natomiast czarny:

```{r}
black_winner_count = sum(df$winner == "black")
print(black_winner_count)
```
Wynika z tego, że szacowane prawdopodobieństwo wygrania gracza białego wynosi w przybliżeniu 49,85%, gracza czarnego 45,40%, a remisu 4,75%.

W dalszej części analizy sprawdzimy, jak to prawdopodobieństwo się zmienia, jeśli odpowiednio uwarunkujemy rozgrywkę. 
